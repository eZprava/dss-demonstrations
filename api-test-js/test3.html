<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <title>DSS PDF validátor — kompaktní SimpleReport</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --ok:#0a7f2e; --bad:#b00020; --warn:#a86e00; --muted:#666; --border:#e6e6e6; --bg:#fafafa;
    }
    *{box-sizing:border-box}
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 18px; color:#111; line-height:1.35 }
    h1,h2,h3,h4 { margin: 0 0 .5rem }
    .card { border: 1px solid var(--border); border-radius: 12px; padding: .8rem .9rem; margin-bottom: .8rem; background:#fff }
    label { display:block; margin:.4rem 0 .2rem; font-weight:600; font-size:.95rem }
    input[type="file"] { padding:.35rem 0 }
    input[type="text"] { width:100%; padding:.45rem .55rem; font-size:.95rem }
    button { padding:.45rem .8rem; font-size:.95rem; border-radius:10px; border:1px solid #ccc; cursor:pointer; background:#fff }
    button:disabled { opacity:.6; cursor:wait }
    .muted { color:var(--muted) }
    .row { display:flex; gap:.6rem; align-items:flex-end; flex-wrap:wrap }
    .kv{ display:grid; grid-template-columns: 200px 1fr; gap:.15rem .6rem; padding:.4rem .55rem; background:var(--bg); border:1px solid var(--border); border-radius:10px; font-size:.92rem }
    .kv.small{ grid-template-columns: 170px 1fr; font-size:.9rem }
    .kv .k{ color:#333; font-weight:600 }
    .sep{ border-top:1px solid var(--border); margin:.6rem 0 }
    .badge{ display:inline-block; padding:.05rem .45rem; border-radius:999px; font-size:.85rem; font-weight:700; border:1px solid transparent; vertical-align:middle }
    .badge.ok{ color:var(--ok); background:#eaf6ee; border-color:#d6ebdc }
    .badge.bad{ color:var(--bad); background:#fdecee; border-color:#f7d2d7 }
    .badge.warn{ color:var(--warn); background:#fff6e5; border-color:#ffe8b3 }
    details{ border:1px dashed var(--border); border-radius:10px; padding:.45rem .55rem; background:#fff; margin:.35rem 0 }
    summary{ cursor:pointer; font-weight:600 }
    ul{ margin:.25rem 0 .25rem 1.1rem }
    .list-inline{ display:flex; gap:.35rem; flex-wrap:wrap }
    .pill{ font-size:.85rem; padding:.05rem .45rem; border:1px solid var(--border); border-radius:999px; background:#fff }
    .code{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#f7f7f7; padding:.05rem .35rem; border-radius:6px; border:1px solid var(--border); font-size:.9rem }
    pre { white-space: pre-wrap; word-break: break-word; margin:0 }
    .toolbar{ display:flex; gap:.5rem; align-items:center; flex-wrap:wrap }
  </style>
</head>
<body>
  <h1>DSS PDF validátor</h1>
  <div class="card">
    <label for="baseUrl">URL služby DSS Validation</label>
    <input id="baseUrl" type="text" value="https://localhost:8443/services/rest/validation/validateSigPdfA" spellcheck="false" />
    <div class="row">
      <div>
        <label for="pdf">Podepsané PDF</label>
        <input id="pdf" type="file" accept="application/pdf,.pdf" />
      </div>
      <div class="toolbar">
        <button id="btn" disabled>Odeslat na validaci</button>
        <button id="toggleAll" style="display:none">Rozbalit vše</button>
      </div>
    </div>
    <div id="status" class="muted">Vyberte soubor…</div>
  </div>

  <div id="summary" class="card" style="display:none"></div>

  <div class="card">
    <h3>Jednoduchá validační zpráva</h3>
    <div id="simpleView" class="muted">—</div>
  </div>
  
  <div class="card">
    <details>
      <summary>Surový SimpleReport (JSON)</summary>
      <pre id="jsonSimple" class="muted">—</pre>
    </details>
  </div>

  <div class="card">
    <h3>Odpověď (JSON – raw)</h3>
    <pre id="jsonOut" class="muted">—</pre>
  </div>

<script>
/* ===== pomocné funkce ===== */
const escapeHtml = (s) => String(s)
  .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
  .replace(/"/g,'&quot;').replace(/'/g,'&#39;');

function toBase64(arrayBuffer) {
  let binary = '';
  const bytes = new Uint8Array(arrayBuffer);
  for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
  return btoa(binary);
}
const isPlainObject = (v)=> Object.prototype.toString.call(v)==='[object Object]';
const isPrimitive = (v)=> v==null || ['string','number','boolean'].includes(typeof v);

/* štítek pro indikaci */
function badge(ind){
  const s = (ind||'').toUpperCase();
  const cls = /TOTAL_PASSED|PASSED/.test(s) ? 'ok' : /FAILED|INDETERMINATE/.test(s) ? 'bad' : 'warn';
  return `<span class="badge ${cls}">${escapeHtml(ind??'—')}</span>`;
}

/* univerzální rekurzivní vykreslování jakékoliv hodnoty (kompaktně) */
function renderAny(value, depth=0){
  if (value === null || value === undefined) return '—';
  if (isPrimitive(value)) {
    // krátké ISO časy nechávám „as-is“
    return `<span>${escapeHtml(value)}</span>`;
  }
  if (Array.isArray(value)) {
    if (value.length === 0) return '<span>[]</span>';
    const primOnly = value.every(isPrimitive);
    if (primOnly && value.join(', ').length <= 120){
      return `<span>[${escapeHtml(value.join(', '))}]</span>`;
    }
    // kompaktní sumář + rozbalovač
    let items = value.map((v,i)=>`<li><span class="code">[${i}]</span> ${renderAny(v, depth+1)}</li>`).join('');
    return `<span>Array(${value.length})</span>
      <details${depth<1?' open':''}><summary>zobrazit položky</summary><ul>${items}</ul></details>`;
  }
  if (isPlainObject(value)) {
    const keys = Object.keys(value);
    if (keys.length === 0) return '<span>{}</span>';
    // jednoradkový sumář
    const sample = keys.slice(0,3).map(k=>`${k}`).join(', ');
    const table = keys.map(k=>`<div class="k">${escapeHtml(k)}</div><div>${renderAny(value[k], depth+1)}</div>`).join('');
    return `<span>Objekt (${keys.length}) – ${escapeHtml(sample)}${keys.length>3?', …':''}</span>
      <details${depth<1?' open':''}><summary>zobrazit pole</summary><div class="kv small">${table}</div></details>`;
  }
  // fallback
  try { return `<span>${escapeHtml(JSON.stringify(value))}</span>`; }
  catch { return `<span>${escapeHtml(String(value))}</span>`; }
}

/* přehledná hlavička */
function headerKV(sr, fileName){
  const docName = sr.DocumentName ?? fileName ?? '—';
  const sigCount = sr.SignaturesCount ?? 0;
  const validCount = sr.ValidSignaturesCount ?? 0;
  const policyName = sr.ValidationPolicy?.PolicyName ?? sr.ValidationPolicy?.policyName ?? '—';
  const validationTime = sr.ValidationTime ?? sr.validationTime ?? '—';

  const topInd = (() => {
    const arr = sr.signatureOrTimestampOrEvidenceRecord || [];
    for (const e of arr){
      const s = e?.Signature?.Indication || e?.Timestamp?.Indication || e?.EvidenceRecord?.Indication;
      if (s) return s;
    }
    return '';
  })();

  return `
    <div class="kv">
      <div class="k">Název dokumentu</div><div>${escapeHtml(docName)}</div>
      <div class="k">Politika</div><div>${escapeHtml(policyName)}</div>
      <div class="k">Čas validace</div><div>${escapeHtml(validationTime)}</div>
      <div class="k">Podpisy</div><div>${sigCount} (platných: <strong>${validCount}</strong>)</div>
      <div class="k">Celkový stav</div><div>${topInd ? badge(topInd) : '—'}</div>
    </div>
  `;
}

/* vykreslení jedné položky Signature / Timestamp / EvidenceRecord – včetně všech polí */
function renderEntry(entry, idx){
  const obj = entry.Signature || entry.Timestamp || entry.EvidenceRecord || {};
  const type = entry.Signature ? 'Podpis' : entry.Timestamp ? 'Časové razítko' : 'Evidence Record';
  const title = obj.Id || obj.Name || `${type} #${idx+1}`;
  const ind = obj.Indication ? badge(obj.Indication) : '—';

  // „hlavička“ položky – pár užitečných polí, ale vše ostatní ukazuji níže 1:1
  const headRows = [];
  if (obj.Indication) headRows.push(`<div class="k">Stav</div><div>${ind}</div>`);
  if (obj.QualificationLevel || obj.Qualification || obj.QualificationLevelForSignature){
    const q = obj.QualificationLevel || obj.Qualification || obj.QualificationLevelForSignature;
    headRows.push(`<div class="k">Kvalifikace</div><div><span class="pill">${escapeHtml(q)}</span></div>`);
  }
  if (obj.SignatureFormat) headRows.push(`<div class="k">Formát</div><div><span class="pill">${escapeHtml(obj.SignatureFormat)}</span></div>`);

  // „všechna pole této položky“ — nic neschováváme
  const allFields = Object.keys(obj).map(k=>`<div class="k">${escapeHtml(k)}</div><div>${renderAny(obj[k])}</div>`).join('');

  return `
    <section class="card" style="padding:.6rem .7rem">
      <h4 style="margin-bottom:.4rem">${escapeHtml(type)} • <span class="code">${escapeHtml(title)}</span></h4>
      ${headRows.length ? `<div class="kv small" style="margin-bottom:.4rem">${headRows.join('')}</div>` : ''}
      <details open>
        <summary>Všechna pole (${Object.keys(obj).length})</summary>
        <div class="kv small">${allFields}</div>
      </details>
    </section>
  `;
}

/* hlavní renderer SimpleReportu — kompaktně a kompletně */
function renderSimpleReport(sr, fileName){
  const entries = Array.isArray(sr.signatureOrTimestampOrEvidenceRecord) ? sr.signatureOrTimestampOrEvidenceRecord : [];

  // sekce položek
  const sig = entries.filter(e=>e.Signature).map(renderEntry).join('');
  const ts  = entries.filter(e=>e.Timestamp).map(renderEntry).join('');
  const er  = entries.filter(e=>e.EvidenceRecord).map(renderEntry).join('');

  // „Všechna top-level pole SimpleReport“
  const excludeTop = new Set(['signatureOrTimestampOrEvidenceRecord']);
  const topRows = Object.keys(sr)
    .filter(k=>!excludeTop.has(k))
    .map(k=>`<div class="k">${escapeHtml(k)}</div><div>${renderAny(sr[k])}</div>`)
    .join('');

  return `
    ${headerKV(sr, fileName)}
    <div class="sep"></div>
    <details open>
      <summary>Všechna top-level pole SimpleReport</summary>
      <div class="kv small">${topRows || '<div class="k">—</div><div>—</div>'}</div>
    </details>
    ${sig ? `<h3>Podpisy</h3>${sig}` : ''}
    ${ts  ? `<h3>Časová razítka</h3>${ts}` : ''}
    ${er  ? `<h3>Evidence Records</h3>${er}` : ''}
    ${(!sig && !ts && !er) ? '<div class="muted">Žádné položky k zobrazení.</div>' : ''}
  `;
}

/* ===== UI logika ===== */
const fileInput = document.getElementById('pdf');
const btn = document.getElementById('btn');
const toggleAll = document.getElementById('toggleAll');
const status = document.getElementById('status');
const jsonOut = document.getElementById('jsonOut');
const jsonSimple = document.getElementById('jsonSimple');
const simpleView = document.getElementById('simpleView');
const summary = document.getElementById('summary');
const baseUrlEl = document.getElementById('baseUrl');

fileInput.addEventListener('change', () => {
  btn.disabled = !fileInput.files.length;
  status.textContent = fileInput.files.length ? `Vybrán soubor: ${fileInput.files[0].name}` : 'Vyberte soubor…';
});

btn.addEventListener('click', async () => {
  const file = fileInput.files[0];
  if (!file) return;
  btn.disabled = true;
  summary.style.display = 'none';
  jsonOut.textContent = 'Odesílám…';
  jsonSimple.textContent = '—';
  simpleView.textContent = '—';
  status.textContent = 'Načítám a odesílám dokument…';

  try {
    const buf = await file.arrayBuffer();
    const b64 = toBase64(buf);
    const payload = { signedDocument: { bytes: b64, name: file.name } };

    const res = await fetch(baseUrlEl.value.trim(), {
      method: 'POST',
      headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch { data = { raw: text }; }
    jsonOut.textContent = JSON.stringify(data, null, 2);

    const sr = data?.SimpleReport || data?.simpleReport || data?.reports?.simpleReport || null;
    if (sr && typeof sr === 'object') {
      // malý souhrn nahoře
      const entries = Array.isArray(sr.signatureOrTimestampOrEvidenceRecord) ? sr.signatureOrTimestampOrEvidenceRecord : [];
      const firstInd = (() => {
        for (const e of entries){
          const s = e?.Signature?.Indication || e?.Timestamp?.Indication || e?.EvidenceRecord?.Indication;
          if (s) return s;
        }
        return '';
      })();
      const validCount = sr.ValidSignaturesCount ?? 0;

      summary.innerHTML = `
        <h3>Souhrn</h3>
        <div>Celkový stav: ${firstInd ? badge(firstInd) : '—'}</div>
        <div>Počet platných podpisů: <strong>${validCount}</strong></div>
      `;
      summary.style.display = 'block';

      // kompaktní kompletní report
      simpleView.classList.remove('muted');
      simpleView.innerHTML = renderSimpleReport(sr, file.name);

      // uložím i surový SimpleReport
      jsonSimple.textContent = JSON.stringify(sr, null, 2);

      // zobrazit tlačítko Rozbalit/Sbalit vše
      toggleAll.style.display = 'inline-block';
    } else {
      simpleView.textContent = 'SimpleReport v odpovědi nenalezen nebo má neznámý formát.';
      simpleView.classList.add('muted');
      toggleAll.style.display = 'none';
    }

    status.textContent = res.ok ? 'Hotovo ✅' : `HTTP ${res.status}`;
  } catch (err) {
    status.textContent = 'Chyba při odesílání.';
    jsonOut.textContent = String(err);
    toggleAll.style.display = 'none';
  } finally {
    btn.disabled = false;
  }
});

/* rozbalit/sbalit všechna <details> */
let expanded = true;
toggleAll.addEventListener('click', ()=>{
  expanded = !expanded;
  document.querySelectorAll('details').forEach(d=> d.open = expanded);
  toggleAll.textContent = expanded ? 'Sbalit vše' : 'Rozbalit vše';
});
</script>
</body>
</html>
